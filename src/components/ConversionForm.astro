---
/**
 * Conversion Form Component - Following Astro Best Practices
 * Server-side rendered component with client-side enhancement via custom element
 * Uses data attributes instead of define:vars (Astro recommendation)
 * Single Responsibility: Handles all conversion form functionality
 */

// For client-side components, always use PUBLIC_API_BASE_URL (browser-accessible)
import { getApiBaseUrl } from '../constants/api.ts';
const apiBaseUrl = getApiBaseUrl();
---

<!-- Custom element wrapper with data attributes (Astro best practice) -->
<conversion-form data-api-url={apiBaseUrl} data-default-mode="bulk">
  <div class="glass-card p-8 lg:h-fit">
    <!-- Content Container -->
    <div id="content-container" class="space-y-8">
      <div class="w-full max-w-2xl mx-auto mb-8">
        <h1 class="text-4xl md:text-6xl font-bold text-apple-white mb-6">
          WordPress to <span class="bg-gradient-to-r from-blue-400 via-purple-500 via-blue-400 to-purple-500 bg-clip-text text-transparent animated-gradient">Shopify</span>
        </h1>
        <p class="text-xl text-apple-white-80 mb-8 max-w-2xl mx-auto">
          Transform your WordPress content into Shopify-ready format with our ultra-modern, 
          AI-powered conversion tool featuring Apple's Liquid Glass design system.
        </p>
        
        <!-- Dynamic Time-Based Greeting -->
        <h2 id="greeting" class="text-2xl font-semibold text-white mb-6">
          What are we working on today?
        </h2>
        
        <!-- Apple-Style Segmented Control - Always Visible -->
        <div class="space-y-6">
          <div class="flex justify-center">
            <div class="liquid-glass-segmented-control p-1 inline-flex rounded-full bg-black/24 backdrop-blur-md border border-white/20">
              <button id="bulk-upload-btn" class="segmented-option active px-6 py-3 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
                Bulk Upload
              </button>
              <button id="single-post-btn" class="segmented-option px-6 py-3 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Single Post
              </button>
            </div>
          </div>
          
          <!-- Mode Description -->
          <div class="text-center max-w-md mx-auto">
            <p id="mode-description" class="text-white/70 text-sm">
              Upload CSV or TXT files containing multiple WordPress URLs
            </p>
          </div>
        </div>
        
        <!-- Single Post Interface -->
        <div id="single-post-interface" class="space-y-4 mt-6 min-h-[200px] sm:min-h-[240px] md:min-h-[280px] lg:min-h-[300px] hidden">
          
          <div class="text-left">
            <label for="wordpress-url" class="block text-sm font-medium text-white/80 mb-2 cursor-pointer">
              WordPress URL
            </label>
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-white/50 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              <input 
                id="wordpress-url"
                type="url" 
                placeholder="https://your-wordpress-site.com/post-url"
                class="glass-input flex-1"
              />
            </div>
          </div>
          
          <button id="convert-now-btn" class="glass-button liquid-glass-interactive w-full px-6 py-3 text-white font-medium bg-gradient-to-r from-blue-500/80 to-purple-600/80 hover:from-blue-600/90 hover:to-purple-700/90 transition-all duration-glass flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Convert Now
          </button>
        </div>
        
        <!-- Bulk Upload Interface (Visible by default) -->
        <div id="bulk-upload-interface" class="space-y-4 mt-6 min-h-[200px] sm:min-h-[240px] md:min-h-[280px] lg:min-h-[300px]">
          
          <div class="text-left">
            <label class="block text-sm font-medium text-white/80 mb-2">
              Upload CSV or TXT File
            </label>
            
            <!-- Drag and Drop Zone -->
            <div id="drop-zone" class="relative border-2 border-dashed border-white/30 rounded-xl p-8 text-center hover:border-white/50 transition-colors cursor-pointer bg-black/20 backdrop-blur-sm">
              <input type="file" id="file-input" accept=".csv,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              
              <svg class="w-12 h-12 mx-auto mb-4 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              
              <p class="text-white/80 font-medium mb-2">Drop your file here or click to browse</p>
              <p class="text-white/50 text-sm">Supports CSV and TXT files with one URL per line</p>
              
              <!-- File name display -->
              <div id="file-name" class="hidden mt-4 p-3 bg-white/10 rounded-lg">
                <p class="text-white/90 text-sm font-medium"></p>
              </div>
            </div>
          </div>
          
          <button id="bulk-convert-btn" class="glass-button liquid-glass-interactive w-full px-6 py-3 text-white font-medium bg-gradient-to-r from-blue-500/80 to-purple-600/80 hover:from-blue-600/90 hover:to-purple-700/90 transition-all duration-glass flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Convert All
          </button>
        </div>
      </div>
    </div>
  </div>
</conversion-form>

<script>
  // Custom element following Astro best practices
  // This script is bundled, optimized, and deduplicated by Astro
  import { ConversionFormManager } from '../scripts/conversionFormManager';
  import { getApiBaseUrl } from '../constants/api.ts';
  
  class ConversionForm extends HTMLElement {
    private formManager: ConversionFormManager | null = null;
    
    connectedCallback() {
      // Read configuration from data attributes (Astro best practice)
      const apiUrl = this.dataset.apiUrl || getApiBaseUrl();
      const defaultMode = (this.dataset.defaultMode as 'bulk' | 'single') || 'bulk';
      
      // Initialize form manager
      this.formManager = new ConversionFormManager({
        apiBaseUrl: apiUrl,
        container: this,
        defaultMode
      });
      
      // Initialize the form functionality
      this.formManager.init();
      
      // Set up job dashboard integration
      this.setupJobDashboardIntegration();
      
      // Set up dynamic greeting functionality
      this.setupGreeting();
    }
    
    disconnectedCallback() {
      // Cleanup when element is removed
      this.formManager = null;
    }
    
    /**
     * Set up integration with JobDashboard component
     */
    private setupJobDashboardIntegration() {
      // Listen for job submissions and refresh the job dashboard
      window.addEventListener('conversionJobSubmitted', (event: Event) => {
        const customEvent = event as CustomEvent;
        console.log('Form submitted, refreshing job dashboard:', customEvent.detail);
        
        // Find JobDashboard component and refresh it
        const jobDashboard = document.querySelector('job-dashboard') as any;
        if (jobDashboard && typeof jobDashboard.refresh === 'function') {
          // Small delay to allow the API call to process
          setTimeout(() => {
            jobDashboard.refresh(true);
          }, 1000);
        }
      });
    }
    
    /**
     * Set up dynamic greeting functionality
     * Following DRY principle - moved from index.astro but kept minimal here
     * TODO: Could be extracted to a separate GreetingManager if it grows
     */
    private setupGreeting() {
      const getTimezoneFromSettings = () => {
        try {
          const settings = JSON.parse(localStorage.getItem('csfrace-settings') || '{}');
          return settings.timezone || 'auto';
        } catch {
          return 'auto';
        }
      };

      const getUserTimezone = () => {
        const settingsTimezone = getTimezoneFromSettings();
        if (settingsTimezone === 'auto') {
          return Intl.DateTimeFormat().resolvedOptions().timeZone;
        }
        return settingsTimezone;
      };

      const getTimeInTimezone = (timezone: string) => {
        const now = new Date();
        if (timezone === 'auto') {
          return now;
        }
        
        try {
          const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: timezone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          
          const parts = formatter.formatToParts(now);
          const dateStr = `${parts.find(p => p.type === 'year')?.value}-${parts.find(p => p.type === 'month')?.value}-${parts.find(p => p.type === 'day')?.value}T${parts.find(p => p.type === 'hour')?.value}:${parts.find(p => p.type === 'minute')?.value}:${parts.find(p => p.type === 'second')?.value}`;
          
          return new Date(dateStr);
        } catch (error) {
          console.warn('Failed to get time in timezone:', timezone, error);
          return now;
        }
      };

      const updateGreeting = () => {
        const userTimezone = getUserTimezone();
        const now = getTimeInTimezone(userTimezone);
        const hour = now.getHours();
        
        // Simple greeting based on time of day
        let greeting = "What are we working on today?";
        
        if (hour >= 5 && hour < 12) {
          greeting = "Good morning! Ready to convert some content?";
        } else if (hour >= 12 && hour < 17) {
          greeting = "Good afternoon! Let's transform some WordPress sites!";
        } else if (hour >= 17 && hour < 21) {
          greeting = "Good evening! Time for some conversion magic?";
        } else {
          greeting = "Working late? Let's make it count with some conversions!";
        }
        
        const greetingElement = this.querySelector('#greeting');
        if (greetingElement) {
          greetingElement.textContent = greeting;
        }
      };
      
      // Initialize greeting once
      updateGreeting();
    }
    
    // Public method for external control
    switchMode(mode: 'bulk' | 'single') {
      this.formManager?.switchMode(mode);
    }
    
    // Public method to get current mode
    getCurrentMode(): 'bulk' | 'single' | null {
      return this.formManager?.getCurrentMode() || null;
    }
  }
  
  // Define the custom element
  customElements.define('conversion-form', ConversionForm);
</script>